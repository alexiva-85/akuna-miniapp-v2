name: Smoke Tests

on:
  push:
    branches: [main]
  deployment_status:
    types: [success]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Smoke test /api/health
      run: |
        echo "Testing /api/health endpoint..."
        response=$(curl -s -w "%{http_code}|%{content_type}|%{header_json}" https://akuna-miniapp-v2.vercel.app/api/health)
        status=$(echo $response | cut -d'|' -f1)
        content_type=$(echo $response | cut -d'|' -f2)
        headers=$(echo $response | cut -d'|' -f3)
        
        echo "Status: $status"
        echo "Content-Type: $content_type"
        echo "Headers: $headers"
        
        if [ "$status" != "200" ]; then
          echo "‚ùå /api/health returned $status, expected 200"
          exit 1
        fi
        
        if [[ "$content_type" != *"application/json"* ]]; then
          echo "‚ùå /api/health content-type is $content_type, expected application/json"
          exit 1
        fi
        
        if [[ "$headers" != *"x-vercel-id"* ]]; then
          echo "‚ùå /api/health missing x-vercel-id header"
          exit 1
        fi
        
        echo "‚úÖ /api/health passed"
        
    - name: Smoke test /dashboard
      run: |
        echo "Testing /dashboard endpoint..."
        response=$(curl -s -w "%{http_code}|%{content_type}|%{header_json}" https://akuna-miniapp-v2.vercel.app/dashboard)
        status=$(echo $response | cut -d'|' -f1)
        content_type=$(echo $response | cut -d'|' -f2)
        headers=$(echo $response | cut -d'|' -f3)
        
        echo "Status: $status"
        echo "Content-Type: $content_type"
        echo "Headers: $headers"
        
        if [ "$status" != "200" ]; then
          echo "‚ùå /dashboard returned $status, expected 200"
          exit 1
        fi
        
        if [[ "$headers" != *"x-vercel-id"* ]]; then
          echo "‚ùå /dashboard missing x-vercel-id header"
          exit 1
        fi
        
        if [[ "$headers" != *"content-security-policy"* ]]; then
          echo "‚ùå /dashboard missing CSP header"
          exit 1
        fi
        
        echo "‚úÖ /dashboard passed"
        
    - name: Smoke test /miniapp
      run: |
        echo "Testing /miniapp endpoint..."
        response=$(curl -s -w "%{http_code}|%{content_type}|%{header_json}" https://akuna-miniapp-v2.vercel.app/miniapp)
        status=$(echo $response | cut -d'|' -f1)
        content_type=$(echo $response | cut -d'|' -f2)
        headers=$(echo $response | cut -d'|' -f3)
        
        echo "Status: $status"
        echo "Content-Type: $content_type"
        echo "Headers: $headers"
        
        if [ "$status" != "200" ]; then
          echo "‚ùå /miniapp returned $status, expected 200"
          exit 1
        fi
        
        if [[ "$headers" != *"x-vercel-id"* ]]; then
          echo "‚ùå /miniapp missing x-vercel-id header"
          exit 1
        fi
        
        if [[ "$headers" != *"content-security-policy"* ]]; then
          echo "‚ùå /miniapp missing CSP header"
          exit 1
        fi
        
        echo "‚úÖ /miniapp passed"
        
    - name: Smoke test / (root redirect)
      run: |
        echo "Testing / (root) endpoint..."
        response=$(curl -s -w "%{http_code}|%{location}|%{header_json}" https://akuna-miniapp-v2.vercel.app/)
        status=$(echo $response | cut -d'|' -f1)
        location=$(echo $response | cut -d'|' -f2)
        headers=$(echo $response | cut -d'|' -f3)
        
        echo "Status: $status"
        echo "Location: $location"
        echo "Headers: $headers"
        
        if [ "$status" != "307" ]; then
          echo "‚ùå / returned $status, expected 307"
          exit 1
        fi
        
        if [[ "$location" != *"/dashboard"* ]]; then
          echo "‚ùå / redirect location is $location, expected /dashboard"
          exit 1
        fi
        
        echo "‚úÖ / (root redirect) passed"
        
    - name: All smoke tests passed
      run: |
        echo "üéâ All smoke tests passed successfully!"
        echo "‚úÖ /api/health - 200 OK (JSON)"
        echo "‚úÖ /dashboard - 200 OK (UI)"
        echo "‚úÖ /miniapp - 200 OK (WebView)"
        echo "‚úÖ / - 307 Redirect to /dashboard"
